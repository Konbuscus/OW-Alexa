'use strict';

// initialize express server for webhook functionality

const app = require('../index').Jovo;
app.logRequest();
const webhook = require('../index').Webhook;
const SoftAccountLinking = require('./dev/softAccountLinking').SoftAccountLinking;
const JovoSdk = require('./dev/jovoSdk').JovoSdk;

let jovoOptions = {
    token: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjdmNmQ4ZDk0OTU1OTJkMzNjYjA2MTJiNjI1ZWI3ODlkZTZmYTdkZTA5ZTkyMTFlN2FlN2IxZjMzOThmZjE3MjFkMDQ5NzllMWNhZjk5YTVjIn0.eyJhdWQiOiIxIiwianRpIjoiN2Y2ZDhkOTQ5NTU5MmQzM2NiMDYxMmI2MjVlYjc4OWRlNmZhN2RlMDllOTIxMWU3YWU3YjFmMzM5OGZmMTcyMWQwNDk3OWUxY2FmOTlhNWMiLCJpYXQiOjE0OTQ0NTExNDUsIm5iZiI6MTQ5NDQ1MTE0NSwiZXhwIjoxNTI1OTg3MTQ1LCJzdWIiOiIxIiwic2NvcGVzIjpbXX0.Q83ktU4G76JmBHUJKnrBDbHmPYBL0mVhP8Iruiu2IZ1HsHG4bsbzyj0lqe5ybywH96BaEP25OgcKO6sCBfTGMEz2rui6pW5c9jm-k1uPawUFVfaps2fXUDHWhB4tksug_5GfBPEBWyU60oybtyzPlgsucgMpyuXOoDMBU95K6dyXKwdiPUsh0GcVADoeg132UWrNqG5PwaDRk5-HEDpFEqKTkgtj3sfArV1D8KdO-VQEUxR3wPbEN-p5mAnk8BV9SEZWWr_amBErmE3ANbFUUWXZwx0c1_DsKR1S5PHkUDCCSYSFrftrMr5IJ3OTiOa_V9gEWL9Q0k_GF8eV--4V7QAbFXPm31JrotpQELfYmuHCNKOTkwPdbmuwY9W35V5c88Axxv_eP4NdrhQdhZVX_bSvRwLMVG2UGTV1qFdzxKMO3keMTs4pLk_xAvgHpXMCHyxsWc0itX3C68iVc31ULUaxK0mHtnS0Y_VWR3I4tXWZ9hWHRJ0mfvpbdT535MolLYRahawI9OKhJSSTKVai37eOI0EpX5jAsyjI27H_Wieffg_NZ0r0MYJ0MN8UJrNLxCyf-Q3qZtRZC-Jx3MR2mXPuER3wngP3ez7sYHKJyQQpRw71jsda-aIvaB8jKEj38Jfb5N7ybzpCMa-olwwClziNg8ODrBpClAdRCLGq-Ts',
    skillId: 'amzn1.ask.skill.9941b2ce-043b-4c94-b0be-d04c51cdb7b0',
};

let sal = new SoftAccountLinking(jovoOptions);
let jSdk = new JovoSdk(jovoOptions);

let http = require('http').createServer( webhook );
let io = require( 'socket.io' )( http );
http.listen(8080, '127.0.0.1', function() {
    console.log('socket.io opened');
});
io.on('connection', function(socket) {
    console.log('a user connected');
});

webhook.listen(3000, function() {
    console.log('Example server listening on port 3000!');
});


// listen for post requests
webhook.post('/webhook', function(req, res) {
    app.handleRequest(req, res, dialogHandler);
    app.execute();
});

let dialogHandler = {

};


let podcastHandlers = {
    'LAUNCH': function() {
        // app.tell('How you doin\'?');
        app.toIntent('PlayIntent');
    },
    'PlayIntent': function() {
        // app.tell('How you doin\'?');
        //  app.audioPlayer().play('https://www.swetlow.de/nextlife.mp3',
        // 'silence');
        app.audioPlayer().play('https://www.swetlow.de/uneasy.mp3',
            'silence3');
        // app.audioPlayer().play('https://s3.amazonaws.com/audio.spokenlayer.com/medium/2017/05/150eec23-30ab-4735-a3a5-042397f4ad07/audio-150eec23-30ab-4735-a3a5-042397f4ad07-encodings.mp3',
        //     'silence3');
        // app.tell('Sure, here\'s your latest article from spoken layer. <break time="200ms"/> <audio src="https://www.jovo.tech/audio/KkvVzWos-audio-150eec23-30ab-4735-a3a5-042397f4ad07-encodings-audiotrimmercom-1.mp3"/>');
        // app.audioPlayer().play('https://www.jovo.tech/audio/gdTU3LQL-nextlife.mp3',
        //     'silence334a', 'REPLACE_ALL');
        // app.audioPlayer().stop();
        // jSdk.notification('Hello', 'World', app.getUserId(), function(body) {
        //     console.log(body);
        //     app.tell('Hello World');
        // });

        // let data = {
        //     token: 'token',
        //     offsetInMilliseconds: 40000,
        // };
        //
        // jSdk.data(data, app.getUserId(), function(body) {
        //     app.tell('Hello World data');
        // });

    },
    'ContinueOnPageIntent': function() {
        setTimeout(function() {
            io.emit('event', 'bla');
            app.emit('respond', app);
        }, 3000);
    },
    'ContinueOnPhone': function() {
        let data = {
            token: 'token',
            offsetInMilliseconds: app.audioPlayer().getOffsetInMilliseconds(),
        };
        console.log(JSON.stringify(app.audioPlayer().getOffsetInMilliseconds(), null, '\t'));
        jSdk.data(data, app.getUserId(), function(body) {
            console.log(body);
            app.audioPlayer().stop();
        });

        // jSdk.data({token: 'token',
        //             offsetInMilliseconds: 10000,
        //             }, app.getUserId(), function(body) {
        //     // app.audioPlayer().stop();
        //     app.tell('Start playing...');
        // });
    },
    'JovoLinkingIntent': function() {
        sal.activate(app.getInput('pin'), app.getUserId(), function(body) {
            console.log(body);
            app.tell('Activated');
        });
    },
    'AMAZON.ResumeIntent': function() {
        // DO STUFF
    },
    'AMAZON.PauseIntent': function() {
        app.audioPlayer().clearQueue();
    },
    'AMAZON.StartOverIntent': function() {
        app.audioPlayer().play('https://www.jovo.tech/audio/gdTU3LQL-nextlife.mp3',
            'silence3');
    },
    'END': function() {
        app.audioPlayer().stop();
    },
    'AUDIOPLAYER': {
        'AudioPlayer.PlaybackStarted': function() {
            console.log('AudioPlayer.PlaybackStarted');
        },
        'AudioPlayer.PlaybackNearlyFinished': function() {
            console.log('AudioPlayer.PlaybackNearlyFinished');
        },
        'AudioPlayer.PlaybackStopped': function() {
            console.log('AudioPlayer.PlaybackStopped');
        },
    },
};
